<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gowsik | Rails 7.1 Adds Support for MessagePack as Message Serializer</title>
  <meta name="description" content="MessagePack is now supported in Rails 7.1, this new serializer enables the generation of smaller payloads and significantly faster serialization and deserialization compared to other serializers.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Rails 7.1 Adds Support for MessagePack as Message Serializer">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://blog.gowsik.info/posts/rails-7-1-message-pack-as-message-serializer">
  <meta property="og:description" content="MessagePack is now supported in Rails 7.1, this new serializer enables the generation of smaller payloads and significantly faster serialization and deserialization compared to other serializers.">
  <meta property="og:site_name" content="Gowsik">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="https://blog.gowsik.info/posts/rails-7-1-message-pack-as-message-serializer">
  <meta name="twitter:title" content="Rails 7.1 Adds Support for MessagePack as Message Serializer">
  <meta name="twitter:description" content="MessagePack is now supported in Rails 7.1, this new serializer enables the generation of smaller payloads and significantly faster serialization and deserialization compared to other serializers.">

  
    <meta property="og:image" content="https://blog.gowsik.info/assets/og-image-39da2ddfef06ae5bdc1b6daa5dcec9e47b2448cbb47e38cce2d4518074bee7ed.jpg">
    <meta name="twitter:image" content="https://blog.gowsik.info/assets/og-image-39da2ddfef06ae5bdc1b6daa5dcec9e47b2448cbb47e38cce2d4518074bee7ed.jpg">
  

  <link href="https://blog.gowsik.info/feed.xml" type="application/rss+xml" rel="alternate" title="Gowsik Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-dark-4c760f0ea4166cfd4d40fb83b479f89aab382364c8585ae59b500b5260102afa.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon-dark-d161409442b7e523089f24d08d0a55951549ece7504207c376d53b020713494d.png">
      <link rel="stylesheet" type="text/css" href="/assets/dark-b9d28dbdfd9e6e202befd4ef315790f4113137f7c4b307fd5df6ae0e46ce6a54.css">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="Gowsik">Gowsik</a>
  <ul class="header-links">
    
      <li>
        <a href="https://gowsik.info" title="About me" target="_blank">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
  <use href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about" xlink:href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/gowsik_ragunath" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/gowsik-ragunath" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:v.gowsik@gmail.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" rel="noreferrer noopener" target="_blank" title="RSS">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-rss">
  <use href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss" xlink:href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss"></use>
</svg>

        </a>
      </li>
    
    
  </ul>
</nav>



        <article class="article scrollappear">
          <header class="article-header">
            <h1>Rails 7.1 Adds Support for MessagePack as Message Serializer</h1>
            <p>MessagePack is now supported in Rails 7.1, this new serializer enables the generation of smaller payloads and significantly faster serialization and deserialization compared to other serializers.</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    November 15, 2023
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      4 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
      
      <a href="/tag/rails" title="See all posts with tag 'Rails'">Rails</a>
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p>This post is also published in <a href="https://blog.saeloun.com/2023/11/15/rails-7-1-message-pack-as-message-serializer/">blog.saeloun.com</a>.</p>

<p>In Rails 7.1, support for MessagePack has been added, and it can be used with <code class="highlighter-rouge">MessageEncryptor</code> and <code class="highlighter-rouge">MessageVerifier</code>. <code class="highlighter-rouge">config.active_support.message_serializer</code> will also accept <code class="highlighter-rouge">:message_pack</code> and <code class="highlighter-rouge">:message_pack_allow_marshal</code> as serializers.</p>

<h3 id="what-is-messagepack">What is MessagePack?</h3>

<p><a href="https://msgpack.org/">MessagePack</a> is an efficient binary serialization format that enables the exchange of data among multiple languages, similar to JSON.</p>

<p>It is faster and more compact compared to JSON, as it is optimized for binary data serialization. Specifically designed for efficiently representing complex data structures, it makes the payload smaller and faster to serialize and deserialize.</p>

<p>The following is a message serialized by <code class="highlighter-rouge">MessagePack</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'msgpack'</span>
<span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">].</span><span class="nf">to_msgpack</span>  <span class="c1">#=&gt; "\x93\x01\x02\x03"</span>
<span class="no">MessagePack</span><span class="p">.</span><span class="nf">unpack</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>   <span class="c1">#=&gt; [1,2,3]</span></code></pre></figure>

<p><a href="https://msgpack.org/index.html#messagepack-for-ruby">Reference</a></p>

<p>Unlike <a href="https://bsonspec.org/">BSON</a>, which is a similar serialization format and less verbose, BSON is designed for faster in-memory manipulation, whereas MessagePack is designed for efficient network communication.</p>

<h3 id="before">Before</h3>

<p>Before Rails 7.1, Rails didnâ€™t have native support for serializing using MessagePack. We had to install the <a href="https://github.com/msgpack/msgpack-ruby">msgpack</a> gem and serialize the message.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/services/secure_message_service.rb</span>

<span class="k">class</span> <span class="nc">SecureMessageService</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">message_encryptor</span><span class="p">.</span><span class="nf">encrypt_and_sign</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">encrypted_message</span><span class="p">)</span>
    <span class="n">message_encryptor</span><span class="p">.</span><span class="nf">decrypt_and_verify</span><span class="p">(</span><span class="n">encrypted_message</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">message_encryptor</span>
    <span class="n">secret_key</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">KeyGenerator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secret_key_base</span><span class="p">).</span><span class="nf">generate_key</span><span class="p">(</span><span class="s1">'salt'</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">MessageEncryptor</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">secret_key</span><span class="p">,</span> <span class="ss">serializer: </span><span class="no">MessagePack</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># rails c</span>

<span class="o">&gt;</span> <span class="n">encrypted_message</span> <span class="o">=</span> <span class="no">SecureMessageService</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">([{</span><span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">"value"</span><span class="p">},</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">{</span><span class="ss">:a</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:b</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">}}])</span>

<span class="o">=&gt;</span> <span class="s2">"AaeKemIH/k7moSB8kgGvsNPJNr7MY1vUlMlwGBk=--AMViwItIvTcwz9Xp--NTMQJJrKKgdA1y1qt/KuWA=="</span>

<span class="o">&gt;</span> <span class="no">SecureMessageService</span><span class="p">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">encrypted_message</span><span class="p">)</span>

<span class="o">=&gt;</span> <span class="p">[{</span><span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">"value"</span><span class="p">},</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">{</span><span class="ss">:a</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:b</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">}}]</span></code></pre></figure>

<p>To use MessagePack with <code class="highlighter-rouge">ActiveSupport::MessageEncryptor</code>, we need to pass serializer argument with the value <code class="highlighter-rouge">MessagePack</code>. This ensures that the messages are serialized and deserialized appropriately during both encryption and decryption processes.</p>

<h3 id="after">After:</h3>

<p>MessagePack is supported starting from Rails 7.1, with <a href="https://github.com/msgpack/msgpack-ruby">msgpack</a> integrated into it. Rails has also introduced a new class called <code class="highlighter-rouge">ActiveSupport::MessagePack</code>, designed to serialize most basic Ruby data types.</p>

<p>To configure MessagePack as the default serializer in the Rails application, include the following in <code class="highlighter-rouge">config/application.rb</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">message_serializer</span> <span class="o">=</span> <span class="ss">:message_pack</span></code></pre></figure>

<p>In Rails 7.1, the default serializer is <code class="highlighter-rouge">json_allow_marshal</code>. However, it can fall back to deserializing with <code class="highlighter-rouge">Marshal</code> so that legacy messages can still be read. We can set MessagePack as the default serializer in the app by using the <code class="highlighter-rouge">config.active_support.message_serializer</code> configuration method and setting the value as <code class="highlighter-rouge">message_pack</code>.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/services/secure_message_service.rb</span>

<span class="k">class</span> <span class="nc">SecureMessageService</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">message_encryptor</span><span class="p">.</span><span class="nf">encrypt_and_sign</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">encrypted_message</span><span class="p">)</span>
    <span class="n">message_encryptor</span><span class="p">.</span><span class="nf">decrypt_and_verify</span><span class="p">(</span><span class="n">encrypted_message</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">message_encryptor</span>
    <span class="n">secret_key</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">KeyGenerator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secret_key_base</span><span class="p">).</span><span class="nf">generate_key</span><span class="p">(</span><span class="s1">'salt'</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">MessageEncryptor</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">secret_key</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Since MessagePack is configured as the message serializer using the <code class="highlighter-rouge">config.active_support.message_serializer</code> method, we do not need to pass the serializer argument to <code class="highlighter-rouge">ActiveSupport::MessageEncryptor</code> as we did in the previous Rails version.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># rails c</span>

<span class="o">&gt;</span> <span class="n">encrypted_message</span> <span class="o">=</span> <span class="no">SecureMessageService</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">([{</span><span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">"value"</span><span class="p">},</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">{</span><span class="ss">:a</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:b</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">}}])</span>

<span class="o">=&gt;</span> <span class="s2">"AaeKemIH/k7moSB8kgGvsNPJNr7MY1vUlMlwGBk=--AMViwItIvTcwz9Xp--NTMQJJrKKgdA1y1qt/KuWA=="</span>

<span class="o">&gt;</span> <span class="no">SecureMessageService</span><span class="p">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">encrypted_message</span><span class="p">)</span>

<span class="o">=&gt;</span> <span class="p">[{</span><span class="ss">:key</span><span class="o">=&gt;</span><span class="s2">"value"</span><span class="p">},</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">{</span><span class="ss">:a</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:b</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">}}]</span>

<span class="o">&gt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Messages</span><span class="o">::</span><span class="no">Codec</span><span class="p">.</span><span class="nf">default_serializer</span>

<span class="o">=&gt;</span> <span class="ss">:message_pack</span></code></pre></figure>

<p><code class="highlighter-rouge">MessageEncryptor</code> will serialize the message using <code class="highlighter-rouge">MessagePack</code> during both encryption and decryption processes. To check the default serializer, we can run <code class="highlighter-rouge">ActiveSupport::Messages::Codec.default_serializer</code>, which returns <code class="highlighter-rouge">message_pack</code>.</p>

<p>Along with <a href="https://guides.rubyonrails.org/v7.1/configuring.html#config-active-support-message-serializer">message_serializer</a>, MessagePack can also be used as <a href="https://guides.rubyonrails.org/v7.1/configuring.html#config-action-dispatch-cookies-serializer">cookies_serializer</a> and <a href="https://guides.rubyonrails.org/v7.1/caching_with_rails.html#configuration">cache_serializer</a>.</p>

          </div>
          <!-- <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=Rails+7.1+Adds+Support+for+MessagePack+as+Message+Serializer%20-%20https://blog.gowsik.info/posts/rails-7-1-message-pack-as-message-serializer%20by%20@gowsik_ragunath" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.gowsik.info/posts/rails-7-1-message-pack-as-message-serializer" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
          </div> -->

          <!--  -->
        </article>
        <footer class="footer scrollappear">
  <p>
    You can read some random facts <a href="https://www.cs.cmu.edu/~bingbin/" target="_blank">here</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-V342LMXNEK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-V342LMXNEK');
  </script>


<script type="text/javascript" src="/assets/vendor-3ee2c63bbac916f96cd7f90e83ab767f058ead1301444c9966f5156911c8be7f.js"></script>


  <script type="text/javascript" src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js"></script>



  <script type="text/javascript" src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js"></script>


<script type="text/javascript" src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js"></script>


</body>
</html>
